// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== MODELS ====================

model User {
  userId         BigInt    @id @default(autoincrement())
  authProvider   String    @default("password")
  email          String?   @unique
  phone          String?   @unique
  passwordHash   String?
  full_name      String
  dob            DateTime? @db.Date
  gender         String?
  address        String?
  avatarUrl      String?
  username       String?   @unique
  localeCode     String    @default("en")
  timezone       String    @default("Asia/Karachi")
  status         String    @default("active")
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  userRoles             UserRole[]
  elderAssignments      ElderAssignment[]       @relation("ElderUser")
  caregiverAssignments  ElderAssignment[]       @relation("CaregiverUser")
  medications           Medication[]            @relation("ElderMedications")
  createdMedications    Medication[]            @relation("CreatedByUser")
  vitalMeasurements     VitalMeasurement[]      @relation("ElderVitals")
  recordedVitals        VitalMeasurement[]      @relation("RecordedByUser")
  notifications         Notification[]
  dietLogs              DietLog[]
  exerciseLogs          ExerciseLog[]
  userDevices           UserDevice[]
  userDocuments         UserDocument[]
  userInvitations       UserInvitation[]
  userLoginEvents       UserLoginEvent[]
  subscriptions         Subscription[]
  userDailySummary      UserDailySummary[]
  medIntakes            MedIntake[]             @relation("ElderMedIntakes")
  recordedMedIntakes    MedIntake[]             @relation("RecordedByUserIntakes")

  @@index([email])
  @@index([phone])
  @@index([status])
  @@map("users")
}

model Role {
  roleId    BigInt     @id @default(autoincrement())
  roleCode  String     @unique
  roleName  String
  isActive  Boolean    @default(true)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  userRoles UserRole[]

  @@map("roles")
}

model UserRole {
  userRoleId BigInt   @id @default(autoincrement())
  userId     BigInt
  roleId     BigInt
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [userId], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [roleId], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@map("user_roles")
}

model ElderAssignment {
  elderAssignmentId  BigInt   @id @default(autoincrement())
  elderUserId        BigInt
  caregiverUserId    BigInt
  relationshipDomain String   @default("relationships")
  relationshipCode   String
  isPrimary          Boolean  @default(false)
  notifyPrefs        Json?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  elder     User @relation("ElderUser", fields: [elderUserId], references: [userId], onDelete: Cascade)
  caregiver User @relation("CaregiverUser", fields: [caregiverUserId], references: [userId], onDelete: Cascade)

  @@unique([elderUserId, caregiverUserId])
  @@index([elderUserId])
  @@index([caregiverUserId])
  @@map("elder_assignments")
}

model Medication {
  medicationId     BigInt   @id @default(autoincrement())
  elderUserId      BigInt
  medicationName   String
  doseValue        Decimal? @db.Decimal(10, 2)
  doseUnitCode     String?
  formCode         String?
  instructions     String?
  notes            String?
  createdByUserId  BigInt?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  elder         User          @relation("ElderMedications", fields: [elderUserId], references: [userId], onDelete: Cascade)
  createdBy     User?         @relation("CreatedByUser", fields: [createdByUserId], references: [userId])
  medSchedules  MedSchedule[]
  medIntakes    MedIntake[]

  @@index([elderUserId])
  @@index([createdByUserId])
  @@map("medications")
}

model MedSchedule {
  medScheduleId        BigInt   @id @default(autoincrement())
  medicationId         BigInt
  timezone             String   @default("Asia/Karachi")
  startDate            DateTime @db.Date
  endDate              DateTime? @db.Date
  daysMask             Int      @default(127)
  timesLocal           Json
  isPrn                Boolean  @default(false)
  snoozeMinutesDefault Int?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  medication Medication @relation(fields: [medicationId], references: [medicationId], onDelete: Cascade)

  @@index([medicationId])
  @@map("med_schedules")
}

model MedIntake {
  medIntakeId        BigInt    @id @default(autoincrement())
  medicationId       BigInt
  elderUserId        BigInt
  scheduledTime      DateTime?
  actualTime         DateTime?
  status             String    @default("pending")
  doseValue          Decimal?  @db.Decimal(10, 2)
  doseUnitCode       String?
  notes              String?
  recordedByUserId   BigInt?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  medication    Medication @relation(fields: [medicationId], references: [medicationId], onDelete: Cascade)
  elder         User       @relation("ElderMedIntakes", fields: [elderUserId], references: [userId], onDelete: Cascade)
  recordedBy    User?      @relation("RecordedByUserIntakes", fields: [recordedByUserId], references: [userId])

  @@index([medicationId])
  @@index([elderUserId])
  @@index([status])
  @@index([scheduledTime])
  @@map("med_intakes")
}

model VitalMeasurement {
  vitalMeasurementId BigInt   @id @default(autoincrement())
  elderUserId        BigInt
  kindCode           String
  unitCode           String?
  value1             Decimal? @db.Decimal(10, 2)
  value2             Decimal? @db.Decimal(10, 2)
  valueText          String?
  recordedAt         DateTime
  source             String   @default("manual")
  deviceInfo         Json?
  recordedByUserId   BigInt?
  notes              String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  elder      User  @relation("ElderVitals", fields: [elderUserId], references: [userId], onDelete: Cascade)
  recordedBy User? @relation("RecordedByUser", fields: [recordedByUserId], references: [userId])

  @@index([elderUserId])
  @@index([kindCode])
  @@index([recordedAt])
  @@map("vital_measurements")
}

model Notification {
  notificationId   BigInt    @id @default(autoincrement())
  userId           BigInt
  title            String
  message          String
  notificationType String
  scheduledTime    DateTime?
  sentTime         DateTime?
  isRead           Boolean?  @default(false)
  isSent           Boolean?  @default(false)
  status           String?   @default("pending")
  createdAt        DateTime? @default(now())
  updatedAt        DateTime? @updatedAt

  user              User               @relation(fields: [userId], references: [userId], onDelete: Cascade)
  notificationLogs  NotificationLog[]

  @@index([userId])
  @@index([status])
  @@index([scheduledTime])
  @@map("notifications")
}

model NotificationLog {
  logId            BigInt    @id @default(autoincrement())
  notificationId   BigInt
  sentAt           DateTime? @default(now())
  deliveryStatus   String?   @default("success")
  responseMessage  String?
  createdAt        DateTime? @default(now())

  notification Notification @relation(fields: [notificationId], references: [notificationId], onDelete: Cascade)

  @@index([notificationId])
  @@map("notification_logs")
}

model Lookup {
  lookupId     BigInt   @id @default(autoincrement())
  lookupDomain String
  lookupCode   String
  lookupLabel  String
  sortOrder    Int      @default(0)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([lookupDomain, lookupCode])
  @@index([lookupDomain])
  @@index([isActive])
  @@map("lookups")
}

model Translation {
  translationId BigInt   @id @default(autoincrement())
  localeCode    String
  messageKey    String
  messageText   String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([localeCode, messageKey])
  @@index([localeCode])
  @@map("translations")
}

model DietLog {
  dietLogId   BigInt   @id @default(autoincrement())
  userId      BigInt
  mealType    String
  description String?
  calories    Int?
  recordedAt  DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@index([userId])
  @@index([recordedAt])
  @@map("diet_logs")
}

model ExerciseLog {
  exerciseLogId BigInt   @id @default(autoincrement())
  userId        BigInt
  exerciseType  String
  duration      Int?
  intensity     String?
  recordedAt    DateTime
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user User @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@index([userId])
  @@index([recordedAt])
  @@map("exercise_logs")
}

model UserDevice {
  userDeviceId    BigInt    @id @default(autoincrement())
  userId          BigInt
  deviceToken     String
  deviceType      String
  deviceName      String?
  isActive        Boolean   @default(true)
  lastActiveAt    DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user User @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@unique([userId, deviceToken])
  @@index([userId])
  @@map("user_devices")
}

model UserDocument {
  userDocumentId BigInt   @id @default(autoincrement())
  userId         BigInt
  documentType   String
  documentUrl    String
  fileName       String
  fileSize       Int?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user User @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@index([userId])
  @@map("user_documents")
}

model UserInvitation {
  userInvitationId BigInt    @id @default(autoincrement())
  inviterUserId    BigInt
  inviteeEmail     String
  inviteePhone     String?
  relationshipCode String
  status           String    @default("pending")
  invitationCode   String    @unique
  expiresAt        DateTime
  acceptedAt       DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  inviter User @relation(fields: [inviterUserId], references: [userId], onDelete: Cascade)

  @@index([inviterUserId])
  @@index([inviteeEmail])
  @@index([status])
  @@map("user_invitations")
}

model UserLoginEvent {
  userLoginEventId BigInt   @id @default(autoincrement())
  userId           BigInt
  loginTime        DateTime @default(now())
  ipAddress        String?
  userAgent        String?
  loginStatus      String   @default("success")

  user User @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@index([userId])
  @@index([loginTime])
  @@map("user_login_events")
}

model SubscriptionPlan {
  subscriptionPlanId BigInt   @id @default(autoincrement())
  planCode           String   @unique
  planName           String
  description        String?
  price              Decimal  @db.Decimal(10, 2)
  currency           String   @default("USD")
  billingCycle       String   @default("monthly")
  features           Json?
  isActive           Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  subscriptions Subscription[]

  @@map("subscription_plans")
}

model Subscription {
  subscriptionId       BigInt    @id @default(autoincrement())
  userId               BigInt
  subscriptionPlanId   BigInt
  status               String    @default("active")
  startDate            DateTime  @default(now())
  endDate              DateTime?
  autoRenew            Boolean   @default(true)
  paymentMethod        String?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  user             User             @relation(fields: [userId], references: [userId], onDelete: Cascade)
  subscriptionPlan SubscriptionPlan @relation(fields: [subscriptionPlanId], references: [subscriptionPlanId])

  @@index([userId])
  @@index([subscriptionPlanId])
  @@index([status])
  @@map("subscriptions")
}

model UserDailySummary {
  userDailySummaryId BigInt   @id @default(autoincrement())
  userId             BigInt
  summaryDate        DateTime @db.Date
  medsCompliance     Decimal? @db.Decimal(5, 2)
  vitalsRecorded     Int?
  stepsCount         Int?
  sleepHours         Decimal? @db.Decimal(4, 2)
  moodScore          Int?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  user User @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@unique([userId, summaryDate])
  @@index([userId])
  @@index([summaryDate])
  @@map("user_daily_summary")
}
